server {
        listen   *:80;
        #listen *:80;
	#listen 127.0.0.1:8080 default;
	server_name support.linux-notes.org  www.support.linux-notes.org;
	#charset koi8-r;
	
	set $root '/home/www/linux-notes/public_html/support';
        root   $root;
	#root /home/www/linux-notes/public_html;
        
        index  index.php index.html index.htm;
	try_files $uri $uri/ /index.php?q=$uri $args;	

	#log access and errors 
 	 access_log /var/log/nginx/access-support.linux-notes.org.log main;
	 error_log /var/log/nginx/error-support.linux-notes.org.log;	
 	 ## redirect www to nowww
      	  #if ($host = 'www.linux-notes.org' ) {
          #				    #rewrite  ^/(.*)$  https://linux-notes.org/$1  permanent;
	  #				    rewrite  ^/(.*)$  http://linux-notes.org/$1  permanent;
          #					  }	

	#GZIP
	   gzip             on;
  	   gzip_min_length  1000;
  	   gzip_proxied     expired no-cache no-store private auth;
  	   gzip_types       text/plain application/xml;
	   gzip_buffers	    32 4k;
	   gzip_comp_level  9;
	   gzip_disable     "msie6";
	   gzip_http_version 1.1;
	   gzip_static on;
	   gzip_vary  on;
	   #gzip_proxied any;
	   #gzip_types       text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml application/x-font-ttf font/opentype;	   	
	   #gzip_types text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;
	


	 #errors
	######################50X####################
	 error_page 500 502 503 504 /50x.html;
 	 location = /50x.html {
        			root /usr/share/nginx/html/;
    			      }
	######################40X#####################
	 error_page 404 /404.htm;
	  location = /404.htm {
				#root /etc/nginx/errors/404;
				 root /home/www/linux-notes/public_html/errors/404;
			      }
	 error_page 403 /403.htm;
	  location = /403.htm {
                                  #root /etc/nginx/errors/403;
                                 root /home/www/linux-notes/public_html/errors/403;
                               }

       	 location = /favicon.ico {
                                   log_not_found off;
                                    access_log off;
                            	  }
	 location = /robots.txt {
                            	  allow all;
                            	  log_not_found off;
                            	  access_log off;
                            	 }
	 # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).
	 # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
	 location ~ /\.ht {
                      	    deny  all;
                      	    access_log off;
                      	    log_not_found off;
                    	   } 
	 # Deny access to any files with a .php extension in the uploads directory
	 # Works in sub-directory installs and also in multisite network
	 # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
	 location ~* /(?:uploads|files)/.*\.php$ {
                                                   deny all;
                                                   access_log off;
                                                   log_not_found off;
                                                 }
	 # deny access to WP config file and license.txt and readme.html files
	 # deny access to .conf files
         #location ~* \.(conf)$ {
         #                        deny all;
         #                       }

	# Define default caching of 24h
	#expires 86400s;
	add_header Pragma public;
	add_header Cache-Control "max-age=86400, public, must-revalidate, proxy-revalidate";
	#add_header X-Whom  linux-notes.org; #\m/___NGINX-DICK___\m/;	
	#add_header X-Your-Port-Header-Here $server_port;
    	#add_header X-Your-Protocol-Header-Here $scheme;
	
	#add_header "X-UA-Compatible" "IE=Edge,chrome=1";

	# Rewrite for versioned CSS+JS via filemtime
	location ~* ^.+\.(css|js)$ {
				     rewrite ^(.+)\.(\d+)\.(css|js)$ $1.$3 last;
				     expires 31536000s;
				     access_log off;
				     log_not_found off;
				     
				     #tcp_nodelay off; ## Set the OS file cache. 
           			     open_file_cache max=100 inactive=120s; 
           			     open_file_cache_valid 45s; 
           			     open_file_cache_min_uses 2; 
           			     open_file_cache_errors off;
					
				     #GZIP
	   			     gzip             on;
  	   			     gzip_min_length  1000;
  	   			     gzip_proxied     expired no-cache no-store private auth;
  	   			     gzip_types       text/plain application/xml;
	   			     gzip_buffers	    32 4k;
	   			     gzip_comp_level  9;
	   			     gzip_disable     "msie6";
	   			     gzip_http_version 1.1;
	   			     gzip_static on;
	   			     gzip_vary  on;
	   			     #gzip_types text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;
	

				     add_header Pragma public;
				     add_header Cache-Control "max-age=31536000, public";
				    


				   }
				

 	# Aggressive caching for static files
	location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
									#access_log off;
									#log_not_found off;    
									#if (-f $request_filename) {
									expires 31536000s;
									access_log off;
									log_not_found off;
									add_header Pragma public;
									add_header Cache-Control "max-age=31536000, public";
									
									tcp_nodelay off; ## Set the OS file cache. 
           								open_file_cache max=100 inactive=120s; 
           								open_file_cache_valid 45s; 
           								open_file_cache_min_uses 2; 
           								open_file_cache_errors off;
									
									#GZIP
	   								gzip             on;
  	  								gzip_min_length  1000;
  	   								gzip_proxied     expired no-cache no-store private auth;
  	   								gzip_types       text/plain application/xml;
	   								gzip_buffers	    32 4k;
	   								gzip_comp_level  9;
	   								gzip_disable     "msie6";
	   								gzip_http_version 1.1;
	   								gzip_static on;
	   								gzip_vary  on;
	   								#gzip_types text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;
	
										
									#fastcgi_hide_header Set-Cookie;
												#}
								}
	location / {
		   try_files $uri $uri/ /index.php?$args;
                   root /home/www/linux-notes/public_html/support;
		   #location ~* ^.+\.(svg|svgz|eot|otf|woff|wri|ttf|css|rss|txt|xsd|xsl|xml|atom|js|jpg|jpeg|gif|png|ico|tif|tiff|bmp|zip|tar|tgz|gz|t?gz|gzip|rar|bz2|doc|docx|rtx|rtf|xls|xlsx|xla|xlt|xlw|exe|ppt|pot|pps|pptx|mid|midi|webm|wma|wave|mp3|mp4|ogg|ogv|wmv|wmx|avi|divx|mpg|mpp|m4a|mpeg|m4v|swf|class|mdb|mov|odf|odg|odp|ods|odt|pdf|qt|asf|asx|odb|odc|wax|ram|)$ {
			#error_log off;
                	#access_log off;
			#if (-f $request_filename) {
        		#		            expires max;
			#			    add_header Pragma public;
			#			    add_header Cache-Control "max-age=31536000, public";
			#			  }
            	  #}

            	  #location ~* (.+\.tpl$) {
                  #			  deny all;
            	  #			 }
            	  # if (!-e $request_filename) {
              	  # 			       rewrite ^(.*)$  /index.php last;
            	  #			      }
            }
	    #end "local /" parameters
	    #
	    # Enable nginx status
            # location /nginx_status {
            #			     stub_status on;
            #			     access_log   off;
            #			     allow 178.151.40.243;
            #			     deny all;
            #			    }
	    # 
              location ~ \.php$ {
				  # This fix shoudn't work though, if nginx and php are not on the same server, other options exist (like unauthorizing php execution within upload folder)
				  # More on this serious security concern in the "Pass Non-PHP Requests to PHP" section, there http://wiki.nginx.org/Pitfalls
				  try_files $uri =404;
				  # PHP	
			   	  # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
				  fastcgi_pass   127.0.0.1:9000;
				  fastcgi_cache fastcgicache;
        			  fastcgi_cache_valid any 1m;
        			  fastcgi_cache_use_stale error timeout invalid_header http_500;
				  fastcgi_split_path_info ^(.+\.php)(/.+)$;
				  fastcgi_index  index.php;
				  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
				  include fastcgi_params;
				  fastcgi_param  QUERY_STRING     $query_string;
				  fastcgi_param  REQUEST_METHOD   $request_method;
				  fastcgi_param  CONTENT_TYPE     $content_type;
				  fastcgi_param  CONTENT_LENGTH   $content_length;
				  
				   #fastcgi_param   DOCUMENT_ROOT   /home/www/document_root;
      				   #fastcgi_param   SCRIPT_FILENAME /home/www/document_root$fastcgi_script_name;
      				   #fastcgi_param   SCRIPT_NAME  $fastcgi_script_name;
				   #fastcgi_param   SERVER_ADDR     $server_addr;
      				   #fastcgi_param   SERVER_PORT     $server_port;
      				   #fastcgi_param   SERVER_PROTOCOL $server_protocol;
      				   fastcgi_param   SERVER_SOFTWARE "nginx-DICK!";
      				   fastcgi_param   GATEWAY_INTERFACE       "CGI/1.1";
      				   fastcgi_param   SERVER_NAME     $server_name;
      				   fastcgi_param   REQUEST_URI     $request_uri;
				   fastcgi_param   REMOTE_USER     $remote_user;
      				   fastcgi_param   REMOTE_ADDR     $remote_addr;
      				   fastcgi_param   REMOTE_PORT     $remote_port;

				  fastcgi_intercept_errors        on;
				  fastcgi_ignore_client_abort     off;
				  fastcgi_connect_timeout 60;
				  fastcgi_send_timeout 180;
				  fastcgi_read_timeout 180;
				  fastcgi_buffers 4 256k;
				  fastcgi_buffer_size 128k;
				  fastcgi_busy_buffers_size 256k;
				  fastcgi_temp_file_write_size 256k;
				  fastcgi_keep_conn on;
				  #Placing a page cache, after 3 usages. Fewer made me difficult to explain the glitches on the registration form
				  fastcgi_cache_min_uses 3;
       				  #Cache listed answers
				  fastcgi_cache_valid 200 301 302 304 5m;
				  #The format of the hash key this key is finding the right page nginx
				  fastcgi_cache_key "$request_method|$host|$request_uri";
			        			
				 }
				 # end "local ~ \.php" parameters
}
#end "server" parameters

