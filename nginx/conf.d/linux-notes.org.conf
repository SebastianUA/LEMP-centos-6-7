#
server {
        listen   *:80;
        #listen *:80;
	#listen 127.0.0.1:8080 default;
	server_name linux-notes.org  www.linux-notes.org;
        # charsets
	 charset utf-8;	
	#charset koi8-r;
	
	set $root '/home/www/linux-notes/public_html';
        root   $root;
	#root /home/www/linux-notes/public_html;
        
        index  index.php index.html index.htm;
	try_files $uri $uri/ /index.php?q=$uri $args;	

	#log access and errors 
	 access_log /var/log/nginx/access-linux-notes.org.log main;
         error_log /var/log/nginx/error-linux-notes.org.log;
	 #REDIRECTS
 	 ## redirect www to nowww
      	  #if ($host = 'www.linux-notes.org' ) {
          #				    #rewrite  ^/(.*)$  https://linux-notes.org/$1  permanent;
	  #				    rewrite  ^/(.*)$  http://linux-notes.org/$1  permanent;
          #
	  #				    }
	  # OR	
	  # enforce https
  	   #return 301 https://$server_name$request_uri;

	  #Gzip
	   include /etc/nginx/global/gzip.conf;

	 #errors
	  include /etc/nginx/global/errors.conf;

	 #WP security
	  include /etc/nginx/global/wp-security.conf;
	 # Add trailing slash to */wp-admin requests.
         rewrite /wp-admin$ $scheme://$host$uri/ permanent;
	
	
	 # Add HEADERS
	  add_header Cache-Control "max-age=86400, public, must-revalidate, proxy-revalidate";
	  add_header X-Whom  linux-notes.org; #\m/___NGINX-DICK___\m/;  
	  #
	  add_header 'Access-Control-Allow-Origin' '*';
    	  add_header 'Access-Control-Allow-Credentials' 'true';
    	  add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken';
    	  add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';

	  #in test
	  # Add headers to serve security related headers
          add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
          add_header X-Content-Type-Options nosniff;
          add_header X-Frame-Options "SAMEORIGIN";
          add_header X-XSS-Protection "1; mode=block";
          add_header X-Robots-Tag none;

       # Define default caching of 24h
	#expires 86400s;
	#add_header Pragma public;
	#add_header X-Your-Port-Header-Here $server_port;
    	#add_header X-Your-Protocol-Header-Here $scheme;
	#add_header "X-UA-Compatible" "IE=Edge,chrome=1";

	# Rewrite for versioned CSS+JS via filemtime
	location ~* ^.+\.(css|js)$ {
				     rewrite ^(.+)\.(\d+)\.(css|js)$ $1.$3 last;
				     expires 31536000s;
				     access_log off;
				     log_not_found off;
				     
				     #tcp_nodelay off; ## Set the OS file cache. 
           			     open_file_cache max=100 inactive=120s; 
           			     open_file_cache_valid 45s; 
           			     open_file_cache_min_uses 2; 
           			     open_file_cache_errors off;
					
				     #GZIP
	   			     include /etc/nginx/global/gzip.conf;
				     add_header Pragma public;
				     add_header Cache-Control "max-age=31536000, public";
				     #add_header Cache-Control "public, must-revalidate, proxy-revalidate";
				   }
				

 	# Aggressive caching for static files
	location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
									#access_log off;
									#log_not_found off;    
									#if (-f $request_filename) {
									expires 31536000s;
									access_log off;
									log_not_found off;
									
									tcp_nodelay off; ## Set the OS file cache. 
           								open_file_cache max=100 inactive=120s; 
           								open_file_cache_valid 45s; 
           								open_file_cache_min_uses 2; 
           								open_file_cache_errors off;
									
									#GZIP
	   								include /etc/nginx/global/gzip.conf;
									add_header Pragma public;
									add_header Cache-Control "max-age=31536000, public";
									#add_header Cache-Control "public, must-revalidate, proxy-revalidate";
									}
	location / {
		    try_files $uri $uri/ /index.php?$args;
		    root /home/www/linux-notes/public_html;
	     	   # 
            	   }
#end "local /" parameters
	  # Enable nginx status
           location /nginx_status {
            			     stub_status on;
            			     access_log   off;
            			     allow 178.151.40.243; #62.64.105.230;
            			     deny all;
            			    }
	  
	  include /etc/nginx/global/php-fpm.conf;
}
#end "server" parameters
#
server {
            listen       443 ssl default deferred;
            #listen [::]:443 ssl spdy;
	    #server_name linux-notes.org  www.linux-notes.org;
            #
	    # charsets
	     charset utf-8;

	    # ROOT DIR 
	     set $root '/home/www/linux-notes/public_html';
	     root   $root;
	     #root /home/www/linux-notes/public_html;	 
	     index  index.php index.html index.htm;
	     try_files $uri $uri/ /index.php?q=$uri $args;
	    # LOGS of accesses and errors    
	     access_log /var/log/nginx/access-linux-notes-SSL.org.log main;
	     error_log /var/log/nginx/error-linux-notes-SSL.org.log;
	    
	    #REDIRECTS
	    # enforce http
             #return 301 http://$server_name$request_uri;
	    #

	    #HEADERS 
	    # tell users to go to SSL version next time
	     #add_header Strict-Transport-Security "max-age=15768000; includeSubdomains;";
	     add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
	    # tell the browser dont allow hosting in a frame
	     add_header X-Frame-Options DENY;
	    #
	      add_header X-Content-Type-Options nosniff;
	    #		
	    # tell the browser we can only talk to self and google analytics.
	     add_header X-Content-Security-Policy "default-src 'self'; \
	     script-src 'self' https://ssl.google-analytics.com; \
	     img-src 'self' https://ssl.google-analytics.com";
	    
	     #add_header "X-UA-Compatible" "IE=Edge,chrome=1";
	      add_header X-XSS-Protection "1; mode=block"; 
	
	    #rewrite ^(.*) http://linux-notes.org$1 permanent;
	     ssl_session_cache               shared:SSL:10m;
             ssl_session_timeout             5m;
	     ssl_session_tickets off; # Requires nginx >= 1.5.9
	     ssl                  on;
             ssl_certificate      /etc/nginx/ssl/linux-notes.org.crt;
             ssl_certificate_key  /etc/nginx/ssl/linux-notes.org.key;
             ssl_dhparam /etc/nginx/ssl/dhparam.pem;
	     #ssl_trusted_certificate /etc/nginx/ssl/linux-notes.org.pem;
	     ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
             ssl_prefer_server_ciphers   on;
             resolver 8.8.8.8 8.8.4.4 valid=300s;
             resolver_timeout 15s;
	     ssl_stapling on;
	     ssl_stapling_verify on; # Requires nginx => 1.3.7
	     ssl_stapling_responder http://OCSP.ComodoCA.com;
	     proxy_ssl_session_reuse off;
            # ciphers chosen and ordered for mix of performance, interoperability and security 
	     ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
	    #ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:kEECDH+AES128:kEECDH:kEDH:-3DES:kRSA+AES128:kEDH+3DES:!LOW:!SEED:!IDEA:!SRP:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:+RC4:RC4:EECDH+AESGCM:AES256+EECDH:AES256+EDH:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-DES-CBC3-SHA:EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!3DES:!DSS:RC4';
	   keepalive_timeout 70;
           
	   #GZIP
	    include /etc/nginx/global/gzip.conf;
	   #errors
	    include /etc/nginx/global/errors.conf;	
	   #WP security
	    include /etc/nginx/global/wp-security.conf;	
	   # Add trailing slash to */wp-admin requests.
            rewrite /wp-admin$ $scheme://$host$uri/ permanent;	
#
# Rewrite for versioned CSS+JS via filemtime
location ~* ^.+\.(css|js)$ {
			     rewrite ^(.+)\.(\d+)\.(css|js)$ $1.$3 last;
			     expires 31536000s;
			     access_log off;
			     log_not_found off;
			     add_header Pragma public;
			     add_header Cache-Control "max-age=31536000, public";
			   }
 # Aggressive caching for static files
location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
				expires 31536000s;
				access_log off;
				log_not_found off;
				add_header Pragma public;
				add_header Cache-Control "max-age=31536000, public";
				}
location / {
	     try_files $uri $uri/ /index.php?$args;
	     root /home/www/linux-notes/public_html; 
            }
#end "local /" parameters 
# Enable nginx status
location /nginx_status {
			stub_status on;
			access_log   off;
			allow 178.151.40.243; #62.64.105.230;
			deny all;
		       }
include /etc/nginx/global/php-fpm.conf;
}
#end "server" parameters for SSL	
