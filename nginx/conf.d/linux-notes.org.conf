server {
        listen   *:80;
        #listen *:80;
	#listen 127.0.0.1:8080 default;
	server_name linux-notes.org  www.linux-notes.org;
	#charset koi8-r;
        expires -1M;
	
	#include conf.d/gzip.conf;
	
	set $root '/home/www/linux-notes/public_html';
        root   $root;
	#root /home/www/linux-notes/public_html;
        
        index  index.php index.html index.htm;
	
	#log access and errors 
	 access_log /var/log/nginx/access-linux-notes.org.log main;
         error_log /var/log/nginx/error-linux-notes.org.log;
	
	gzip on;
	gzip_types text/css application/x-javascript text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/ x-icon;
	
	#errors
	 error_page 500 502 503 504 /50x.html;
 	 location = /50x.html {
        			root /usr/share/nginx/html/;
    			      }
	# deny access to WP config file and license.txt and readme.html files
	location ~ (xmlrpc.php|wp-config.php|wp-settings.php|readme.html|license.txt)$ {
											return 404;
											access_log off;
											}
        location / {
		   try_files $uri $uri/ /index.php?$args;
                   location ~* ^.+\.(svg|svgz|eot|otf|woff|wri|ttf|css|rss|txt|xsd|xsl|xml|atom|js|jpg|jpeg|gif|png|ico|tif|tiff|bmp|zip|tar|tgz|gz|t?gz|gzip|rar|bz2|doc|docx|rtx|rtf|xls|xlsx|xla|xlt|xlw|exe|ppt|pot|pps|pptx|mid|midi|webm|wma|wave|mp3|mp4|ogg|ogv|wmv|wmx|avi|divx|mpg|mpp|m4a|mpeg|m4v|swf|class|mdb|mov|odf|odg|odp|ods|odt|pdf|qt|asf|asx|odb|odc|wax|ram|)$ {
			error_log off;
                	access_log off;
			if (-f $request_filename) {
        				            expires max;
						    add_header Pragma public;
						    add_header Cache-Control "max-age=31536000, public";
						  }
            	  }

            	  location ~* (.+\.tpl$) {
                			  deny all;
            				 }
            	   if (!-e $request_filename) {
              				       rewrite ^(.*)$  /index.php last;
            				      }
	    	  location = /favicon.ico {
            		                   log_not_found off;
                        	      	   access_log off;
                          	          }
 	          location = /robots.txt {
            		                  allow all;
                        	          log_not_found off;
                          	          access_log off;
                          	          }
	     # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).
	     # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
	     location ~ /\.ht {
            		        deny  all;
                    		access_log off;
		    		log_not_found off;
		   		}
	     # Deny access to any files with a .php extension in the uploads directory
	     # Works in sub-directory installs and also in multisite network
	     # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
	     location ~* /(?:uploads|files)/.*\.php$ {
							  deny all;
  							  #access_log off;
						          #log_not_found off;
					 	     }
 	     # deny access to WP config file and license.txt and readme.html files
 	     # deny access to .conf files
 	     location ~* \.(conf)$ {
   				    deny all;
				   } 

	     # Add trailing slash to */wp-admin requests.
	     rewrite /wp-admin$ $scheme://$host$uri/ permanent;
        
            }
	    #end "local /" parameters 

              location ~ \.php$ {
				  # This fix shoudn't work though, if nginx and php are not on the same server, other options exist (like unauthorizing php execution within upload folder)
				  # More on this serious security concern in the "Pass Non-PHP Requests to PHP" section, there http://wiki.nginx.org/Pitfalls
				  try_files $uri =404;
				  # PHP	
			   	  # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
				  fastcgi_pass   127.0.0.1:9000;
				  fastcgi_cache fastcgicache;
        			  fastcgi_cache_valid any 1m;
        			  fastcgi_cache_use_stale error timeout invalid_header http_500;
				  fastcgi_split_path_info ^(.+\.php)(/.+)$;
				  fastcgi_index  index.php;
				  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
				  include fastcgi_params;
				  fastcgi_param  QUERY_STRING     $query_string;
				  fastcgi_param  REQUEST_METHOD   $request_method;
				  fastcgi_param  CONTENT_TYPE     $content_type;
				  fastcgi_param  CONTENT_LENGTH   $content_length;
				  
				   #fastcgi_param   DOCUMENT_ROOT   /home/www/document_root;
      				   #fastcgi_param   SCRIPT_FILENAME /home/www/document_root$fastcgi_script_name;
      				   #fastcgi_param   SCRIPT_NAME  $fastcgi_script_name;
				   #fastcgi_param   SERVER_ADDR     $server_addr;
      				   #fastcgi_param   SERVER_PORT     $server_port;
      				   #fastcgi_param   SERVER_PROTOCOL $server_protocol;
      				   fastcgi_param   SERVER_SOFTWARE "nginx-DICK!";
      				   fastcgi_param   GATEWAY_INTERFACE       "CGI/1.1";
      				   fastcgi_param   SERVER_NAME     $server_name;
      				   fastcgi_param   REQUEST_URI     $request_uri;
				   fastcgi_param   REMOTE_USER     $remote_user;
      				   fastcgi_param   REMOTE_ADDR     $remote_addr;
      				   fastcgi_param   REMOTE_PORT     $remote_port;

				  fastcgi_intercept_errors        on;
				  fastcgi_ignore_client_abort     off;
				  fastcgi_connect_timeout 60;
				  fastcgi_send_timeout 180;
				  fastcgi_read_timeout 180;
				  fastcgi_buffers 4 256k;
				  fastcgi_buffer_size 128k;
				  fastcgi_busy_buffers_size 256k;
				  fastcgi_temp_file_write_size 256k;
				  fastcgi_keep_conn on;
				  #Placing a page cache, after 3 usages. Fewer made me difficult to explain the glitches on the registration form
				  fastcgi_cache_min_uses 3;
       				  #Cache listed answers
				  fastcgi_cache_valid 200 301 302 304 5m;
				  #The format of the hash key this key is finding the right page nginx
				  fastcgi_cache_key "$request_method|$host|$request_uri";
			        			
				 }
				 # end "local ~ \.php" parameters
}
#end "server" parameters

server {
            listen       443;
            #server_name https://linux-notes.org  https://www.linux-notes.org;
            ssl_session_cache               shared:SSL:10m;
            ssl_session_timeout             5m;
            ssl                  on;
            ssl_certificate      /etc/nginx/ssl/linux-notes.org.crt;
            ssl_certificate_key  /etc/nginx/ssl/linux-notes.org.key;
            ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
            ssl_prefer_server_ciphers   on;
            ssl_stapling on;
            ssl_dhparam /etc/nginx/ssl/dhparam.pem;
            #ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW     !3DES !MD5 !EXP !PSK !SRP !DSS";
 
            #ssl_ciphers " EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW     !3DES !MD5 !EXP !PSK !SRP !DSS +RC4 RC4";
            #ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RS    A-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3    -SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
            ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA2    56:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:EC    DHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AE    S128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-    SHA';
           keepalive_timeout 70;
           fastcgi_param SSL_VERIFIED $ssl_client_verify;
           fastcgi_param SSL_CLIENT_SERIAL $ssl_client_serial;
           fastcgi_param SSL_CLIENT_CERT $ssl_client_cert;
           fastcgi_param SSL_DN $ssl_client_s_dn;
           add_header Strict-Transport-Security max-age=15768000;
           access_log /var/log/nginx/access-linux-notes-SSL.org.log main;
           error_log /var/log/nginx/error-linux-notes-SSL.org.log;
           include conf.d/gzip.conf;
           root /home/www/linux-notes/public_html;
           index  index.php index.html index.htm;
 
  location / {
               try_files $uri $uri/ /index.php?$args;
              }
 
  # PHP-FPM
  # PHP scripts -> PHP-FPM server listening on 127.0.0.1:9000
  location ~ \.php$ {
             # The following line prevents malicious php code to be executed through some uploaded file (without php extension, like image)
             # This fix shoudn't work though, if nginx and php are not on the same server, other options exist (like unauthorizing php execution within up    load folder)
            # More on this serious security concern in the "Pass Non-PHP Requests to PHP" section, there http://wiki.nginx.org/Pitfalls
            try_files $uri =404; 
              # PHP   
              # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
              fastcgi_pass   127.0.0.1:9000;
              fastcgi_index  index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              include fastcgi_params;
              fastcgi_param  QUERY_STRING     $query_string;
              fastcgi_param  REQUEST_METHOD   $request_method;
              fastcgi_param  CONTENT_TYPE     $content_type;
              fastcgi_param  CONTENT_LENGTH   $content_length;
              fastcgi_intercept_errors        on;
              fastcgi_ignore_client_abort     off;
              fastcgi_connect_timeout 60;
              fastcgi_send_timeout 180;
              fastcgi_read_timeout 180;
              fastcgi_buffers 4 256k;
              fastcgi_buffer_size 128k;
              fastcgi_busy_buffers_size 256k;
              fastcgi_temp_file_write_size 256k; 
              }
             #----------------------------------------------------------
             # Define default caching of 24h
              expires 86400s;
              add_header Pragma public;
              add_header Cache-Control "max-age=86400, public, must-revalidate, proxy-revalidate"; 
             # Rewrite for versioned CSS+JS via filemtime
  location ~* ^.+\.(css|js)$ {
                             rewrite ^(.+)\.(\d+)\.(css|js)$ $1.$3 last;
                             expires 31536000s;
                             access_log off;
                             log_not_found off;
                             add_header Pragma public;
                             add_header Cache-Control "max-age=31536000, public";
                             }
  
    # Aggressive caching for static files
  location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
                                                  expires 31536000s;
                                                  access_log off;
                                                  log_not_found off;
                                                  add_header Pragma public;
                                                  add_header Cache-Control "max-age=31536000, public";
                                                  }
  #----------------------------------------------------------
  #/wordpress-w3-total-cache.conf
  gzip on;
  gzip_types text/css application/x-javascript text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon;
  location ~ \.(css|js)$ {
          		    expires max;
          	            break;
                        }
  location ~ \.(rtf|rtx|svg|svgz|txt|xsd|xsl|xml)$ {
          					    expires 3600;
          					    break;
 						 }
  location ~ \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|pdf|png|pot|pps|ppt|pptx|ra|ram|swf|tar|tif|tiff|wav|wma|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
          expires max;
          break;
          }
  add_header "X-UA-Compatible" "IE=Edge,chrome=1";
  #----------------------------------------------------------
   location ~ /(\.|wp-config.php|readme.html|license.txt) {
                                                           return 404;
                                                          }
   location = /favicon.ico {
                            log_not_found off;
                            access_log off;
                            }
   location = /robots.txt {
                            allow all;
                            log_not_found off;
                            access_log off;
                            }
   location ~ /\.ht {
                      deny  all;
                      access_log off;
                      log_not_found off;
                    }
 
}
